- name: Slurm cluster head node configuration
  hosts: head-node
  become: yes
  vars_files:
    - group_vars/all.yml
    - group_vars/head-node.yml
    - group_vars/VAULT
    - group_vars/users.yml
  pre_tasks:
    - name: Attach volume to instance
      include_role:
        name: attached-volumes
    - name: Make /mnt/home
      file:
        path: /mnt/home
        state: directory
    - name: make the shared directory
      file:
        path: /mnt/shared
        state: directory
  roles:
    - common
    - galaxyproject.repos
    - geerlingguy.pip
    - geerlingguy.nfs
    - mariadb
    - galaxyproject.slurm
    - galaxyproject.cvmfs #Optional if you want singularity containers etc. 
  post_tasks:
    - name: Reload exports file
      command: "exportfs -ra"
    - name: Restart munge service
      service:
        name: munge
        state: restarted
    - name: Install slurm-drmaa
      package:
        name: slurm-drmaa1
        state: latest

- name: Slurm cluster worker node configuration
  hosts: worker-nodes
  become: yes
  vars_files:
    - group_vars/all.yml
    - group_vars/worker-nodes.yml
    - group_vars/VAULT
    - group_vars/users.yml
  roles:
    - common
    - galaxyproject.repos
    - geerlingguy.pip
    - galaxyproject.slurm
    - mounts
    - galaxyproject.cvmfs
  post_tasks:
    - name: Restart munge service
      service:
        name: munge
        state: restarted